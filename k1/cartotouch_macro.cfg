[gcode_macro CARTOGRAPHER_TOUCH]
rename_existing: _CARTOGRAPHER_TOUCH
gcode:
    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if camera_started %}
    STOP_CAMERA
    {% endif %}
    G4 P1000
    _CARTOGRAPHER_TOUCH {rawparams}
    G4 P1000
    {% if camera_started %}
    START_CAMERA
    {% endif %}


[gcode_macro CARTOGRAPHER_THRESHOLD_SCAN]
rename_existing: _CARTOGRAPHER_THRESHOLD_SCAN
gcode:
    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if camera_started %}
    STOP_CAMERA
    {% endif %}
    G4 P1000
    _CARTOGRAPHER_THRESHOLD_SCAN {rawparams}
    G4 P1000
    {% if camera_started %}
    START_CAMERA
    {% endif %}


[gcode_macro SCREWS_TILT_CALCULATE]
rename_existing: _SCREWS_TILT_CALCULATE
gcode:
    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if camera_started %}
    STOP_CAMERA
    {% endif %}
    G4 P1000
    _SCREWS_TILT_CALCULATE {rawparams}
    G4 P1000
    {% if camera_started %}
    START_CAMERA
    {% endif %}


[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set ADAPTIVE = params.ADAPTIVE|default(None) %}
    {% set max_velocity = printer.toolhead.max_velocity %}
    {% set max_accel = printer.toolhead.max_accel %}
    {% set max_accel_to_decel = printer.toolhead.max_accel_to_decel %}
    {% set square_corner_velocity = printer.toolhead.square_corner_velocity %}
    G4 P1000
    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if camera_started %}
    STOP_CAMERA
    {% endif %}
    BED_MESH_CLEAR                                                                  # clear current mesh
    G4 P500                                                                         # wait required to prevent MCU overload / inconsistant meshing
    {% if not ADAPTIVE %}
    RESPOND TYPE=command MSG='Setting VELOCITY=400 ACCEL={max_accel * 0.75} (was {max_accel}), ACCEL_TO_DECEL={max_accel_to_decel * 0.5} (was {max_accel_to_decel}), SQUARE_CORNER_VELOCITY=25 (was {square_corner_velocity})'
    SET_VELOCITY_LIMIT VELOCITY=400 ACCEL={max_accel * 0.75} ACCEL_TO_DECEL={max_accel * 0.5} SQUARE_CORNER_VELOCITY=25   # drop accels to prevent hyper agressive meshing
    {% endif %}
    _BED_MESH_CALIBRATE {rawparams}                                                 # start bedmesh calibrate
    G4 P500                                                                         # wait required to prevent MCU overload / inconsistant mesh calculation
    {% if not ADAPTIVE %}
    RESPOND TYPE=command MSG='Restoring VELOCITY={max_velocity} ACCEL={max_accel}, ACCEL_TO_DECEL={max_accel_to_decel}, SQUARE_CORNER_VELOCITY={square_corner_velocity}'
    SET_VELOCITY_LIMIT VELOCITY={max_velocity} ACCEL={max_accel} ACCEL_TO_DECEL={max_accel_to_decel} SQUARE_CORNER_VELOCITY={square_corner_velocity}
    {% endif %}
    {% if camera_started %}
    START_CAMERA
    {% endif %}
    G4 P1000


[gcode_macro AXIS_TWIST_COMPENSATION_CALIBRATE]
rename_existing: _AXIS_TWIST_COMPENSATION_CALIBRATE
gcode:
    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if camera_started %}
    STOP_CAMERA
    {% endif %}
    G4 P1000
    _AXIS_TWIST_COMPENSATION_CALIBRATE {rawparams}
    G4 P1000
    {% if camera_started %}
    RESPOND TYPE=command MSG='You need to run START_CAMERA on completion'
    {% endif %}
