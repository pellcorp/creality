#!/bin/sh

GUPPYFLO=/usr/data/guppyflo/guppyflo
PID_FILE="/var/run/guppyflo.pid"

start_server() {
    sync && echo 3 > /proc/sys/vm/drop_caches
    start-stop-daemon -S -b -m -p $PID_FILE --exec $GUPPYFLO -- -c /usr/data/guppyflo -l /usr/data/printer_data/logs -tcpproxy
}

stop_server() {
    start-stop-daemon -K -q -p $PID_FILE
}

case "$1" in
    start)
        start_server
        ;;
    stop)
        stop_server
        ;;
    restart|reload)
        stop_server
        # this allows a graceful restart of service by actually waiting for it to stop first
        service_pid="$(cat $PID_FILE 2> /dev/null)"
        if [ -n "$service_pid" ]; then
            while true; do
                    if [ ! -d /proc/"$service_pid" ] ; then
                        break
                    fi
            done
        fi
        start_server
        ;;
    *)
        echo "Usage:"
        echo "    $0 {start|stop|restart}"
        exit 1
esac

exit $?
