#!/bin/sh

PID_FILE="/var/run/mjpg_streamer.pid"

# change this to syncframes but only if you have a creality camera
INPUT_TYPE=uvc

case "$1" in
  start)
    V4L_DEVICE=$(v4l2-ctl --list-devices|grep -A1 usb|sed 's/^[[:space:]]*//g'|grep '^/dev' | head -1)
    if [ "x$V4L_DEVICE" = "x" ]; then
      echo "WARNING: No webcams found!"
      exit 1
    fi

    export LD_LIBRARY_PATH=/usr/data/mjpg-streamer/lib/:/usr/data/mjpg-streamer/lib/mjpg-streamer/
    if [ "$INPUT_TYPE" = "syncframes" ]; then
        start-stop-daemon -S -b -m -p $PID_FILE --exec "/usr/data/mjpg-streamer/bin/mjpg_streamer" -- -i "/usr/data/mjpg-streamer/lib/mjpg-streamer/input_syncframes.so -r 1280x720 -m -camera_device0 $V4L_DEVICE" -o "/usr/data/mjpg-streamer/lib/mjpg-streamer/output_http.so -p 8080"
    else
        start-stop-daemon -S -b -m -p $PID_FILE --exec "/usr/data/mjpg-streamer/bin/mjpg_streamer" -- -i "/usr/data/mjpg-streamer/lib/mjpg-streamer/input_uvc.so -r 1280x720 -d $V4L_DEVICE -f 10 -n -timeout 15" -o "/usr/data/mjpg-streamer/lib/mjpg-streamer/output_http.so -p 8080"
    fi
    ;;
  stop)
    start-stop-daemon -K -p $PID_FILE > /dev/null 2>&1
    ;;

  restart|reload)
    "$0" stop
    "$0" start
    ;;
  *)
    echo "Usage:"
    echo "    $0 {start|stop|restart}"
    exit 1
esac

exit $?
