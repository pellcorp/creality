[gcode_macro CARTOGRAPHER_SCAN_CALIBRATE]
rename_existing: _CARTOGRAPHER_SCAN_CALIBRATE
gcode:
  {% set verify_firmware = printer["gcode_macro _CARTOGRAPHER_VARIABLES"].verify_firmware %}
  {% set mcu_version = printer['mcu cartographer'].mcu_version|default('') %}
  {% if verify_firmware and 'K1' not in mcu_version %}
    RESPOND TYPE=error MSG="Calibration Aborted: You must flash the cartographer with K1 specific firmware!"
    RESPOND TYPE=error MSG="See https://pellcorp.github.io/creality-wiki/invalid-cartographer-firmware"
  {% else %}
    _CARTOGRAPHER_SCAN_CALIBRATE {rawparams}
  {% endif %}


[gcode_macro CARTOGRAPHER_TOUCH_CALIBRATE]
rename_existing: _CARTOGRAPHER_TOUCH_CALIBRATE
gcode:
  {% set verify_firmware = printer["gcode_macro _CARTOGRAPHER_VARIABLES"].verify_firmware %}
  {% set mcu_version = printer['mcu cartographer'].mcu_version|default('') %}
  {% if verify_firmware and 'K1' not in mcu_version %}
    RESPOND TYPE=error MSG="Calibration Aborted: You must flash the cartographer with K1 specific firmware!"
    RESPOND TYPE=error MSG="See https://pellcorp.github.io/creality-wiki/invalid-cartographer-firmware"
  {% else %}
    _CARTOGRAPHER_TOUCH_CALIBRATE {rawparams}
  {% endif %}


[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
variable_stop_start_camera: False
gcode:
  {% set verify_firmware = printer["gcode_macro _CARTOGRAPHER_VARIABLES"].verify_firmware %}
  {% set mcu_version = printer['mcu cartographer'].mcu_version|default('') %}
  {% if verify_firmware and 'K1' not in mcu_version %}
    RESPOND TYPE=error MSG="Bed Mesh Calibrate Aborted: You must flash the cartographer with K1 specific firmware!"
    RESPOND TYPE=error MSG="See https://pellcorp.github.io/creality-wiki/invalid-cartographer-firmware"
  {% else %}
    {% if printer["gcode_macro _SAF_BED_MESH_START"] != null %}
      _SAF_BED_MESH_START
    {% endif %}

    {% set camera_started = printer["gcode_macro START_CAMERA"].started|default(true) %}
    {% if stop_start_camera and camera_started %}
      G4 P1000
      STOP_CAMERA
      G4 P1000
    {% endif %}

    {% set start_print = (params.START_PRINT|default(0) == '1') %}
    {% if not start_print %}
      {% set max_velocity = printer.toolhead.max_velocity %}
      {% set max_accel = printer.toolhead.max_accel %}
      {% set square_corner_velocity = printer.toolhead.square_corner_velocity %}
      {% set start_max_velocity = [printer["gcode_macro _START_END_PARAMS"].start_max_velocity, max_velocity]|min %}
      {% set start_max_accel = [printer["gcode_macro _START_END_PARAMS"].start_max_accel, max_accel]|min %}
      {% set start_square_corner_velocity = [printer["gcode_macro _START_END_PARAMS"].start_square_corner_velocity, square_corner_velocity]|min %}

      {% if max_velocity > start_max_velocity or max_accel > start_max_accel or square_corner_velocity > start_square_corner_velocity %}
        RESPOND TYPE=command MSG='Setting VELOCITY={start_max_velocity} (was {max_velocity}) ACCEL={start_max_accel} (was {max_accel}) SQUARE_CORNER_VELOCITY={start_square_corner_velocity} (was {square_corner_velocity})'
        SET_VELOCITY_LIMIT VELOCITY={start_max_velocity} ACCEL={start_max_accel} SQUARE_CORNER_VELOCITY={start_square_corner_velocity}
      {% endif %}
    {% endif %}

    G4 P1000 # give the MCU a break after bed mesh
    _BED_MESH_CALIBRATE {rawparams}
    G4 P1000 # give the MCU a break after bed mesh

    {% if not start_print %}
      {% if max_velocity > start_max_velocity or max_accel > start_max_accel or square_corner_velocity > start_square_corner_velocity %}
        RESPOND TYPE=command MSG='Restoring VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={square_corner_velocity}'
        SET_VELOCITY_LIMIT VELOCITY={max_velocity} ACCEL={max_accel} SQUARE_CORNER_VELOCITY={square_corner_velocity}
      {% endif %}
    {% endif %}

    {% if stop_start_camera and camera_started %}
      G4 P1000
      START_CAMERA
      G4 P1000
    {% endif %}

    {% if printer["gcode_macro _SAF_BED_MESH_END"] != null %}
      _SAF_BED_MESH_END
    {% endif %}
  {% endif %}


[gcode_macro CARTOGRAPHER_AXIS_TWIST_COMPENSATION]
rename_existing: _CARTOGRAPHER_AXIS_TWIST_COMPENSATION
variable_stop_start_camera: True
gcode:
  {% set verify_firmware = printer["gcode_macro _CARTOGRAPHER_VARIABLES"].verify_firmware %}
  {% set mcu_version = printer['mcu cartographer'].mcu_version|default('') %}
  {% if verify_firmware and 'K1' not in mcu_version %}
    RESPOND TYPE=error MSG="Axis Twist Compensation aborted: You must flash the cartographer with K1 specific firmware!"
    RESPOND TYPE=error MSG="See https://pellcorp.github.io/creality-wiki/invalid-cartographer-firmware"
  {% else %}
    {% if stop_start_camera %}
      G4 P1000
      STOP_CAMERA
      G4 P1000
    {% endif %}

    _CARTOGRAPHER_AXIS_TWIST_COMPENSATION {rawparams}

    {% if stop_start_camera %}
      RESPOND TYPE=command MSG='You need to run START_CAMERA on completion'
    {% endif %}
  {% endif %}
